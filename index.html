<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>APIM 업로드·목록 미니앱</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:24px;background:#f8fafc;color:#0f172a}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;margin-bottom:16px}
    .btn{padding:10px 14px;border:1px solid #334155;border-radius:10px;background:#0f172a;color:#fff;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    input,button{font-size:14px}
    input{border:1px solid #cbd5e1;border-radius:10px;padding:8px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 12px;border-top:1px solid #e2e8f0;font-size:12px;word-break:break-all}
    th{background:#f1f5f9;text-align:left}
    pre{white-space:pre-wrap;word-break:break-word;background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:12px}
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- CDN React -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <script>
  const { useMemo, useRef, useState } = React;

  function App(){
    const [apimBase, setApimBase] = useState("");
    const [subscriptionKey, setSubscriptionKey] = useState("");
    const [filename, setFilename] = useState("");
    const [busy, setBusy] = useState(false);
    const [status, setStatus] = useState("");
    const [uploadResult, setUploadResult] = useState(null);
    const [files, setFiles] = useState([]);
    const [rawXml, setRawXml] = useState("");
    const [previewUrl, setPreviewUrl] = useState("");
    const fileRef = useRef(null);

    const headers = useMemo(()=>({"Ocp-Apim-Subscription-Key": subscriptionKey.trim()}),[subscriptionKey]);
    const ready = useMemo(()=> apimBase.startsWith("http") && subscriptionKey.length>0, [apimBase, subscriptionKey]);

    function toast(msg){
      setStatus(msg);
      clearTimeout(toast._tid);
      toast._tid = setTimeout(()=>setStatus(""), 6000);
    }

    function joinUrl(base, path){
      const sep = base.endsWith("/") ? "" : "/";
      const p = path.startsWith("/") ? path.slice(1) : path;
      return base + sep + p;
    }

    async function handleUpload(){
      try{
        if(!ready) return toast("APIM URL과 구독키를 입력해주세요.");
        const file = fileRef.current?.files?.[0];
        if(!file) return toast("업로드할 파일을 선택해주세요.");
        setBusy(true); setUploadResult(null); setPreviewUrl("");

        const form = new FormData();
        form.append("file", file);
        if(filename.trim()) form.append("filename", filename.trim());

        const url = joinUrl(apimBase, "/vm/upload");
        const res = await fetch(url, { method:"POST", headers, body: form });
        const data = await res.json().catch(()=> ({}));
        if(!res.ok) throw new Error(data?.error || ("업로드 실패: " + res.status));

        setUploadResult(data);
        setPreviewUrl(data?.url || "");
        toast("업로드 성공!");
      } catch(e){
        console.error(e);
        toast(e.message || "업로드 중 오류");
      } finally {
        setBusy(false);
      }
    }

    async function handleList(){
      try{
        if(!ready) return toast("APIM URL과 구독키를 입력해주세요.");
        setBusy(true); setFiles([]); setRawXml("");

        const url = joinUrl(apimBase, "/blob/files");
        const res = await fetch(url, { method:"GET", headers });
        const text = await res.text();
        if(!res.ok) throw new Error("목록 조회 실패: " + res.status);

        setRawXml(text);
        const parsed = parseBlobListXml(text);
        setFiles(parsed);
        toast("목록 " + parsed.length + "건");
      } catch(e){
        console.error(e);
        toast(e.message || "목록 조회 중 오류");
      } finally {
        setBusy(false);
      }
    }

    function parseBlobListXml(xml){
      try{
        const dom = new DOMParser().parseFromString(xml, "application/xml");
        return Array.from(dom.querySelectorAll("Blob")).map(b=>{
          const name = b.querySelector("Name")?.textContent || "";
          const url  = b.querySelector("Url, > Url")?.textContent || "";
          return { name, url };
        });
      }catch(e){ console.warn("XML 파싱 실패", e); return []; }
    }

    return (
      React.createElement("div", {style:{maxWidth:960, margin:"0 auto"}},
        React.createElement("h1", null, "APIM 업로드·목록 테스트 (노빌드)"),
        React.createElement("div", {className:"card"},
          React.createElement("h3", null, "연결 설정"),
          React.createElement("div", {style:{display:"grid", gap:8, gridTemplateColumns:"1fr 1fr"}},
            React.createElement("div", null,
              React.createElement("div", null, "APIM 기본 URL"),
              React.createElement("input", {placeholder:"https://<apim>.azure-api.net", value:apimBase, onChange:e=>setApimBase(e.target.value)})
            ),
            React.createElement("div", null,
              React.createElement("div", null, "구독 키"),
              React.createElement("input", {placeholder:"Ocp-Apim-Subscription-Key", value:subscriptionKey, onChange:e=>setSubscriptionKey(e.target.value)})
            )
          ),
          React.createElement("div", {style:{marginTop:8, fontSize:12, color:"#475569"}},
            "업로드: /vm/upload · 목록: /blob/files")
        ),
        React.createElement("div", {className:"card"},
          React.createElement("h3", null, "파일 업로드"),
          React.createElement("div", {style:{display:"grid", gap:8, gridTemplateColumns:"2fr 1fr"}},
            React.createElement("input", {type:"file", ref:fileRef}),
            React.createElement("input", {placeholder:"저장 파일명(선택)", value:filename, onChange:e=>setFilename(e.target.value)})
          ),
          React.createElement("div", {style:{display:"flex", gap:8, marginTop:8}},
            React.createElement("button", {onClick:handleUpload, disabled:busy || !ready, className:"btn"}, "업로드 요청"),
            React.createElement("button", {onClick:()=>{setUploadResult(null); setPreviewUrl(""); setFilename(""); if(fileRef.current) fileRef.current.value="";}, className:"btn", style:{background:"#fff", color:"#0f172a"}}, "초기화")
          ),
          uploadResult && React.createElement("div", {style:{marginTop:12}},
            React.createElement("div", null, "응답"),
            React.createElement("pre", null, JSON.stringify(uploadResult, null, 2))
          ),
          previewUrl && React.createElement("div", {style:{marginTop:12}},
            React.createElement("div", null, "미리보기"),
            React.createElement("a", {href:previewUrl, target:"_blank", rel:"noreferrer"}, previewUrl)
          )
        ),
        React.createElement("div", {className:"card"},
          React.createElement("h3", null, "Blob 파일 목록"),
          React.createElement("div", {style:{display:"flex", gap:8}},
            React.createElement("button", {onClick:handleList, disabled:busy || !ready, className:"btn"}, "목록 조회"),
            React.createElement("button", {onClick:()=>{setFiles([]); setRawXml("");}, className:"btn", style:{background:"#fff", color:"#0f172a"}}, "지우기")
          ),
          files.length>0 && React.createElement("div", {style:{marginTop:12, overflow:"auto"}},
            React.createElement("table", null,
              React.createElement("thead", null, React.createElement("tr", null, React.createElement("th", null, "이름"), React.createElement("th", null, "링크"))),
              React.createElement("tbody", null,
                files.map((f,i)=> React.createElement("tr", {key:i},
                  React.createElement("td", null, f.name),
                  React.createElement("td", null, f.url ? React.createElement("a", {href:f.url, target:"_blank", rel:"noreferrer"}, f.url) : "(정책에 Url 미포함)")
                ))
              )
            )
          ),
          rawXml && React.createElement("details", {style:{marginTop:12}},
            React.createElement("summary", null, "원본 XML 보기"),
            React.createElement("pre", null, rawXml)
          )
        ),
        status && React.createElement("div", {style:{position:"fixed",left:"50%",bottom:24,transform:"translateX(-50%)",background:"#0f172a",color:"#fff",padding:"8px 14px",borderRadius:999}}, status)
      )
    );
  }

  const root = ReactDOM.createRoot(document.getElementById("root"));
  root.render(React.createElement(App));
  </script>
</body>
</html>
